pipeline {
    agent any

    // This file is required to sign the binaries for Windows and MacOs, see https://wiki.eclipse.org/IT_Infrastructure_Doc#Sign_my_Jar.2Fplugins.2FWindows_exe.2FmacOS_App_files.3F

    environment {
        GITHUB_TOKEN = credentials('github-bot-token')
    }

    stages {
        stage('Download') {
            steps {
                script {
                    sh 'curl -L https://github.com/eclipse-esmf/esmf-aspect-model-editor-backend/releases/download/v5.1.1/ame-backend-5.1.1-win.exe -o ame-backend-5.1.1-win.exe'
                }
            }
        }

        stage('Sign Windows') {
            steps {
                script {
                    sh 'curl -o signed.exe -F file=@ame-backend-5.1.1-win.exe https://cbi.eclipse.org/authenticode/sign'
                }
            }
        }

        stage('Upload File to GitHub Release') {
            steps {
                script {
                    def repo = "eclipse-esmf/esmf-aspect-model-editor-backend"
                    def tagName = "v5.2.1"
                    def fileName = "signed.exe"

                    sh """
                        curl -L \\
                             -H "Accept: application/vnd.github+json" \\
                             -H "Authorization: Bearer <YOUR-TOKEN>" \\
                             -H "X-GitHub-Api-Version: 2022-11-28" \\
                             https://api.github.com/repos/${repo}/releases/tags/${tagName}

                    """
                    def releaseId = sh(script: """
                        curl -s -L \\
                             -H "Accept: application/vnd.github+json" \\
                             -H "Authorization: Bearer \$GITHUB_TOKEN" \\
                             https://api.github.com/repos/${repo}/releases/tags/${tagName} | jq -r '.id'
                    """, returnStdout: true).trim()

                    sh """
                        curl -L \
                             -X POST \
                             -H "Accept: application/vnd.github+json" \\
                             -H "Authorization: Bearer \$GITHUB_TOKEN" \
                             -H "Content-Type: application/octet-stream" \
                             --data-binary @${fileName} \
                             "https://uploads.github.com/repos/${repo}/releases/${releaseId}/assets?name=${fileName}"
                    """
                }
            }
        }
    }
}
