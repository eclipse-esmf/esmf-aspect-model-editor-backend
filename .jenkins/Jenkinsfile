pipeline {
    agent any

    environment {
        GITHUB_BOT_TOKEN = credentials('github-bot-token')
    }

    stages {
        stage('Read parameters file') {
            steps {
                script {
                    if (fileExists('parameters.txt')) {
                        // Read the file
                        def fileContent = readFile('parameters.txt').trim()

                        // Split the file content into lines
                        def lines = fileContent.split("\n")

                        // Iterate over the lines and set the environment variables
                        lines.each { line ->
                            def parts = line.split('=')
                            if (parts.size() == 2) {
                                env[parts[0]] = parts[1]
                            }
                        }

                        echo "Artifact URL Win: ${env.artifact_url_win}"
                        echo "Artifact URL Mac: ${env.artifact_url_mac}"
                        echo "Version: ${env.version}"
                    } else {
                        echo "Error: parameters.txt does not exist."
                    }
                }
            }
        }

        stage('Download and unpack Windows artifact') {
            steps {
                script {
                    sh "curl -L -H 'Accept: application/vnd.github.v3+json' \
                        -H 'Authorization: Bearer ${GITHUB_BOT_TOKEN}' \
                        '${env.artifact_url_win}' \
                        --output 'aspect-model-editor-v${env.version}-win.zip'"
                    sh "mkdir -p unpack_dir"
                    sh "unzip -o aspect-model-editor-v${env.version}-win.zip -d unpack_dir"
                    sh "ls -a unpack_dir"
                }
            }
        }

        stage('Download Mac artifact') {
            steps {
                script {
                    sh "curl -L -H 'Accept: application/vnd.github.v3+json' \
                        -H 'Authorization: Bearer ${GITHUB_BOT_TOKEN}' \
                        '${env.artifact_url_mac}' \
                        --output 'ame-backend-${env.version}-mac'"
                    sh "ls -a"
                }
            }
        }

        stage('Sign Windows Applications') {
            steps {
                script {
                    sh "mkdir -p signed_dir"
                    sh "find unpack_dir -name '*.dll' -exec mv {} signed_dir \\;"
                    sh "curl -o signed_dir/ame-backend-${env.version}-win.exe -F file=@unpack_dir/ame-backend-${env.version}-win.exe https://cbi.eclipse.org/authenticode/sign"
                    sh "zip -r aspect-model-editor-v${env.version}-win-signed.zip signed_dir"
                }
            }
        }

        stage('Sign Mac Applications') {
            steps {
                script {
                    sh "mkdir -p signed_dir"
                    sh "curl -o signed_dir/ame-backend-${env.version}-mac -F file=@ame-backend-${env.version}-mac https://cbi.eclipse.org/macos/codesign/sign"
                    sh "ls -a"
                }
            }
        }

        stage('Release signed Windows and Mac artifact to GitHub Releases') {
            steps {
                script {
                    def repo = "eclipse-esmf/esmf-aspect-model-editor-backend"
                    def tagName = "v${env.version}"
                    def fileNameWin = "aspect-model-editor-v${env.version}-win-signed.zip"
                    def fileNameMac = "ame-backend-${env.version}-mac"
                    def releaseId = ""

                    def tagExists = sh(script: """
                        curl -s -L \\
                             -H "Accept: application/vnd.github+json" \\
                             -H "Authorization: Bearer \$GITHUB_BOT_TOKEN" \\
                             https://api.github.com/repos/${repo}/git/refs/tags/${tagName} | jq -r '.ref'
                    """, returnStdout: true).trim()

                    if (tagExists == "null") {
                        // Tag does not exist, create a new one
                        releaseId = sh(script: """
                            curl -s -L \\
                                 -H "Accept: application/vnd.github+json" \\
                                 -H "Authorization: Bearer \$GITHUB_BOT_TOKEN" \\
                                 -X POST \\
                                 -d '{ "tag_name": "${tagName}", "name": "${tagName}", "body": "Release ${tagName}" }' \\
                                 https://api.github.com/repos/${repo}/releases | jq -r '.id'
                        """, returnStdout: true).trim()
                    } else {
                        // Tag exists, use the existing one
                        releaseId = sh(script: """
                            curl -s -L \\
                                 -H "Accept: application/vnd.github+json" \\
                                 -H "Authorization: Bearer \$GITHUB_BOT_TOKEN" \\
                                 https://api.github.com/repos/${repo}/releases/tags/${tagName} | jq -r '.id'
                        """, returnStdout: true).trim()
                    }

                    sh """
                    curl -L \
                         -X POST \
                         -H "Accept: application/vnd.github+json" \\
                         -H "Authorization: Bearer \$GITHUB_BOT_TOKEN" \
                         -H "Content-Type: application/octet-stream" \
                         --data-binary @${fileName} \
                         "https://uploads.github.com/repos/${repo}/releases/${releaseId}/assets?name=${fileNameWin}"
                    """

                    sh """
                    curl -L \
                         -X POST \
                         -H "Accept: application/vnd.github+json" \\
                         -H "Authorization: Bearer \$GITHUB_BOT_TOKEN" \
                         -H "Content-Type: application/octet-stream" \
                         --data-binary @${fileName} \
                         "https://uploads.github.com/repos/${repo}/releases/${releaseId}/assets?name=${fileNameMac}"
                    """

                    sh """
                    curl -X DELETE \
                         -H "Authorization: Bearer \$GITHUB_BOT_TOKEN" \
                         "https://api.github.com/repos/eclipse-esmf/esmf-aspect-model-editor-backend/git/refs/heads/pre_release_configuration"
                    """
                }
            }
        }
    }
}
